<template>
  <div class="vu-meter-container" :class="{ 'hardware-mode': isHardwareRoute }">
    <!-- Debug controls -->
    <div class="debug-controls" style="position: absolute; top: 10px; right: 10px; z-index: 100;">
      <button @click="toggleMode" style="padding: 5px 10px; background: #333; color: white; border: 1px solid #666;">
        Mode: {{ isCompressionMode ? 'Compression' : 'Demo' }}
      </button>
      <div style="margin-top: 5px; font-size: 11px; color: #666;">
        <div>N: Play/Pause</div>
        <div>M: Audio Modal</div>
        <div>T: Test Compression</div>
      </div>
    </div>
    <svg width="800" height="480" viewBox="0 0 800 480" fill="none" xmlns="http://www.w3.org/2000/svg" ref="vuMeterSvg">
      <defs>
        <filter id="filter0_d_39_1020" x="-6.8" y="-9.80003" width="839.6" height="519.6" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
          <feFlood flood-opacity="0" result="BackgroundImageFix"/>
          <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
          <feOffset dx="13" dy="10"/>
          <feGaussianBlur stdDeviation="9.9"/>
          <feComposite in2="hardAlpha" operator="out"/>
          <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.33 0"/>
          <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_39_1020"/>
          <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_39_1020" result="shape"/>
        </filter>
        <linearGradient id="paint0_linear_39_1020" x1="400" y1="0" x2="400" y2="480" gradientUnits="userSpaceOnUse">
          <stop stop-color="#D5D28F"/>
          <stop offset="1" stop-color="#FEF888"/>
        </linearGradient>
        <clipPath id="clip0_39_1020">
          <rect width="800" height="480" fill="white"/>
        </clipPath>
        <mask id="mask0_39_1020" style="mask-type:luminance" maskUnits="userSpaceOnUse" x="63" y="79" width="672" height="248">
          <g id="clippath">
            <path d="M734.404 326.506L134.306 324.009L65.5579 277.305L63.354 79H734.404V326.506Z" fill="white"/>
          </g>
        </mask>
        <mask id="mask1_39_1020" style="mask-type:luminance" maskUnits="userSpaceOnUse" x="61" y="80" width="676" height="251">
          <g id="clippath-1">
            <path d="M395.636 190.603C515.64 190.603 623.239 244.74 695.449 329.882L736.758 330.055V80.815H61L63.2154 280.508L110.986 312.969C182.677 237.619 283.779 190.603 395.636 190.603Z" fill="white"/>
          </g>
        </mask>
        <mask id="mask2_39_1020" style="mask-type:luminance" maskUnits="userSpaceOnUse" x="-42" y="19" width="872" height="414">
          <g id="clippath-2">
            <path d="M829.264 19.2448H-41.2336V432.005H829.264V19.2448Z" fill="white"/>
          </g>
        </mask>
        <mask id="mask3_39_1020" style="mask-type:luminance" maskUnits="userSpaceOnUse" x="476" y="79" width="259" height="293">
          <g id="clippath-3">
            <path d="M716.438 311.2L652.098 371.776L476.627 329.835L545.364 82.5606L734.404 79L716.438 311.2Z" fill="white"/>
          </g>
        </mask>
      </defs>
      
      <g id="VUMeterStates" clip-path="url(#clip0_39_1020)">
        <rect id="Background" width="800" height="480" fill="url(#paint0_linear_39_1020)" :style="{ opacity: hardwareStore.backgroundBrightness }"/>
        
        <!-- VU LEVEL INDICATOR text -->
        <path id="VU LEVEL INDICATOR" d="M265.629 90.1385H265.944L271.07 76.9846H274.31L268.047 93.0401H263.477L257.215 76.9846H260.503L265.629 90.1385ZM292.112 76.9846V85.3267C292.112 86.842 291.79 88.2122 291.145 89.4373C290.516 90.6624 289.646 91.6215 288.534 92.3147C287.421 93.0079 286.18 93.3544 284.81 93.3544C283.424 93.3544 282.166 93.0079 281.038 92.3147C279.926 91.6215 279.047 90.6624 278.402 89.4373C277.774 88.2122 277.459 86.842 277.459 85.3267V76.9846H280.53V85.3267C280.53 86.2778 280.707 87.1321 281.062 87.8898C281.433 88.6474 281.941 89.2438 282.585 89.6791C283.246 90.0982 283.988 90.3078 284.81 90.3078C285.616 90.3078 286.341 90.0982 286.986 89.6791C287.631 89.2438 288.131 88.6474 288.485 87.8898C288.856 87.1321 289.041 86.2778 289.041 85.3267V76.9846H292.112ZM307.308 90.1385H316.448V93.0401H304.237V76.9846H307.308V90.1385ZM322.987 83.5615H331.837V86.439H322.987V90.1385H334.859V93.0401H319.916V76.9846H334.859V79.862H322.987V83.5615ZM345.962 90.1385H346.276L351.402 76.9846H354.642L348.38 93.0401H343.81L337.547 76.9846H340.835L345.962 90.1385ZM360.862 83.5615H369.712V86.439H360.862V90.1385H372.735V93.0401H357.792V76.9846H372.735V79.862H360.862V83.5615ZM379.848 90.1385H388.988V93.0401H376.777V76.9846H379.848V90.1385ZM400.107 76.9846H403.177V93.0401H400.107V76.9846ZM410.71 81.9415V93.0401H407.639V76.9846H410.372L419.85 88.059V76.9846H422.921V93.0401H420.14L410.71 81.9415ZM427.404 76.9846H435.044C436.544 76.9846 437.898 77.3312 439.107 78.0243C440.316 78.7014 441.259 79.6524 441.936 80.8776C442.629 82.1027 442.975 83.4809 442.975 85.0123C442.975 86.5276 442.629 87.8978 441.936 89.1229C441.259 90.3481 440.316 91.3072 439.107 92.0004C437.898 92.6935 436.544 93.0401 435.044 93.0401H427.404V76.9846ZM435.044 90.1385C435.947 90.1385 436.753 89.9209 437.462 89.4856C438.188 89.0504 438.752 88.4459 439.155 87.6721C439.558 86.8823 439.76 85.9957 439.76 85.0123C439.76 84.029 439.558 83.1505 439.155 82.3767C438.752 81.5868 438.188 80.9743 437.462 80.539C436.753 80.0877 435.947 79.862 435.044 79.862H430.474V90.1385H435.044ZM446.719 76.9846H449.79V93.0401H446.719V76.9846ZM466.003 83.5615C465.745 82.4009 465.205 81.4659 464.383 80.7567C463.561 80.0474 462.578 79.6927 461.433 79.6927C460.531 79.6927 459.717 79.9265 458.991 80.394C458.282 80.8453 457.726 81.474 457.323 82.28C456.92 83.086 456.718 83.9968 456.718 85.0123C456.718 86.0118 456.92 86.9145 457.323 87.7205C457.726 88.5265 458.282 89.1632 458.991 89.6307C459.717 90.0821 460.531 90.3078 461.433 90.3078C462.578 90.3078 463.561 89.9531 464.383 89.2438C465.205 88.5346 465.745 87.5996 466.003 86.439H469.268C469.074 87.793 468.615 88.994 467.889 90.0418C467.18 91.0896 466.261 91.9036 465.133 92.484C464.021 93.0643 462.787 93.3544 461.433 93.3544C459.934 93.3544 458.58 92.9998 457.371 92.2905C456.162 91.5651 455.211 90.5657 454.518 89.2922C453.841 88.0187 453.502 86.5921 453.502 85.0123C453.502 83.4326 453.841 82.006 454.518 80.7325C455.211 79.459 456.162 78.4596 457.371 77.7342C458.58 77.0088 459.934 76.6461 461.433 76.6461C462.787 76.6461 464.021 76.9362 465.133 77.5165C466.261 78.0969 467.18 78.9109 467.889 79.9587C468.615 81.0065 469.074 82.2075 469.268 83.5615H466.003ZM484.627 93.0401L483.055 88.9295H475.608L474.06 93.0401H470.82L477.083 76.9846H481.653L487.916 93.0401H484.627ZM482.016 86.0521L479.283 79.4026L476.672 86.0521H482.016ZM503.347 76.9846V79.862H497.229V93.0401H494.182V79.862H488.065V76.9846H503.347ZM513.973 93.3544C512.474 93.3544 511.12 92.9998 509.911 92.2905C508.702 91.5651 507.751 90.5657 507.057 89.2922C506.38 88.0187 506.042 86.5921 506.042 85.0123C506.042 83.4326 506.38 82.006 507.057 80.7325C507.751 79.459 508.702 78.4596 509.911 77.7342C511.12 77.0088 512.474 76.6461 513.973 76.6461C515.472 76.6461 516.826 77.0088 518.035 77.7342C519.244 78.4596 520.187 79.459 520.864 80.7325C521.557 82.006 521.904 83.4326 521.904 85.0123C521.904 86.5921 521.557 88.0187 520.864 89.2922C520.187 90.5657 519.244 91.5651 518.035 92.2905C516.826 92.9998 515.472 93.3544 513.973 93.3544ZM509.258 85.0123C509.258 86.0118 509.459 86.9145 509.862 87.7205C510.265 88.5265 510.821 89.1632 511.531 89.6307C512.256 90.0821 513.07 90.3078 513.973 90.3078C514.876 90.3078 515.69 90.0821 516.415 89.6307C517.14 89.1632 517.705 88.5265 518.108 87.7205C518.527 86.9145 518.736 86.0118 518.736 85.0123C518.736 83.9968 518.527 83.086 518.108 82.28C517.705 81.474 517.14 80.8453 516.415 80.394C515.69 79.9265 514.876 79.6927 513.973 79.6927C513.07 79.6927 512.256 79.9265 511.531 80.394C510.821 80.8453 510.265 81.474 509.862 82.28C509.459 83.086 509.258 83.9968 509.258 85.0123ZM528.729 93.0401H525.658V76.9846H536.66C538.031 76.9846 539.135 77.4279 539.973 78.3145C540.811 79.185 541.23 80.3456 541.23 81.7964C541.23 83.0699 540.86 84.1257 540.118 84.964C539.393 85.8022 538.426 86.2858 537.217 86.4148L541.23 93.0401H537.773L533.904 86.439H528.729V93.0401ZM536.66 83.5615C537.112 83.5615 537.474 83.4165 537.748 83.1263C538.023 82.82 538.16 82.4251 538.16 81.9415V81.4821C538.16 80.9985 538.023 80.6116 537.748 80.3214C537.474 80.0151 537.112 79.862 536.66 79.862H528.729V83.5615H536.66Z" fill="#504523"/>
        
        <!-- MASTR Design Engineering -->
        <g id="MASTR" opacity="0.50">
          <path id="DESIGN ENGINEERING" d="M306.952 364.067H310.712C311.45 364.067 312.116 364.237 312.711 364.578C313.306 364.912 313.77 365.38 314.104 365.983C314.445 366.585 314.615 367.264 314.615 368.017C314.615 368.763 314.445 369.437 314.104 370.04C313.77 370.643 313.306 371.115 312.711 371.457C312.116 371.798 311.45 371.968 310.712 371.968H306.952V364.067ZM310.712 370.54C311.156 370.54 311.553 370.433 311.902 370.219C312.259 370.005 312.537 369.707 312.735 369.326C312.933 368.938 313.033 368.501 313.033 368.017C313.033 367.533 312.933 367.101 312.735 366.72C312.537 366.332 312.259 366.03 311.902 365.816C311.553 365.594 311.156 365.483 310.712 365.483H308.463V370.54H310.712ZM320.23 367.303H324.585V368.72H320.23V370.54H326.073V371.968H318.719V364.067H326.073V365.483H320.23V367.303ZM335.512 366.435C335.512 366.102 335.333 365.836 334.976 365.637C334.619 365.431 334.147 365.328 333.56 365.328C332.925 365.328 332.441 365.419 332.108 365.602C331.775 365.784 331.608 366.046 331.608 366.387C331.608 366.681 331.767 366.895 332.084 367.03C332.402 367.157 332.921 367.22 333.643 367.22C334.873 367.22 335.765 367.407 336.321 367.779C336.884 368.152 337.166 368.743 337.166 369.553C337.166 370.393 336.856 371.032 336.237 371.468C335.627 371.905 334.734 372.123 333.56 372.123C332.846 372.123 332.215 372.02 331.668 371.814C331.128 371.599 330.708 371.302 330.406 370.921C330.105 370.54 329.954 370.1 329.954 369.6H331.454C331.454 369.933 331.648 370.203 332.037 370.409C332.425 370.608 332.933 370.707 333.56 370.707C334.234 370.707 334.754 370.608 335.119 370.409C335.484 370.211 335.666 369.925 335.666 369.553C335.666 369.235 335.492 369.005 335.143 368.862C334.802 368.72 334.254 368.648 333.5 368.648C332.31 368.648 331.446 368.47 330.906 368.113C330.375 367.756 330.109 367.18 330.109 366.387C330.109 365.578 330.402 364.963 330.99 364.543C331.577 364.114 332.433 363.9 333.56 363.9C334.242 363.9 334.845 364.007 335.369 364.221C335.892 364.428 336.297 364.725 336.583 365.114C336.868 365.495 337.011 365.935 337.011 366.435H335.512ZM341.253 364.067H342.765V371.968H341.253V364.067ZM354.659 368.017C354.659 368.771 354.496 369.461 354.171 370.088C353.846 370.715 353.386 371.211 352.791 371.576C352.204 371.94 351.525 372.123 350.756 372.123C350.018 372.123 349.352 371.948 348.757 371.599C348.162 371.242 347.694 370.75 347.353 370.124C347.019 369.497 346.853 368.795 346.853 368.017C346.853 367.24 347.019 366.538 347.353 365.911C347.694 365.284 348.162 364.793 348.757 364.436C349.352 364.079 350.018 363.9 350.756 363.9C351.605 363.9 352.351 364.126 352.993 364.578C353.636 365.031 354.104 365.637 354.397 366.399L352.66 366.423C352.446 366.105 352.172 365.856 351.839 365.673C351.506 365.491 351.145 365.399 350.756 365.399C350.312 365.399 349.911 365.514 349.554 365.745C349.205 365.967 348.931 366.276 348.733 366.673C348.535 367.069 348.435 367.518 348.435 368.017C348.435 368.509 348.535 368.954 348.733 369.35C348.931 369.747 349.205 370.06 349.554 370.29C349.911 370.512 350.312 370.624 350.756 370.624C351.295 370.624 351.767 370.457 352.172 370.124C352.577 369.791 352.85 369.35 352.993 368.803H350.756V367.387H354.612C354.643 367.569 354.659 367.779 354.659 368.017ZM360.279 366.506V371.968H358.768V364.067H360.113L364.777 369.517V364.067H366.289V371.968H364.92L360.279 366.506ZM378.293 367.303H382.649V368.72H378.293V370.54H384.136V371.968H376.782V364.067H384.136V365.483H378.293V367.303ZM389.898 366.506V371.968H388.386V364.067H389.731L394.396 369.517V364.067H395.907V371.968H394.539L389.898 366.506ZM407.812 368.017C407.812 368.771 407.649 369.461 407.324 370.088C406.999 370.715 406.538 371.211 405.943 371.576C405.356 371.94 404.678 372.123 403.908 372.123C403.171 372.123 402.504 371.948 401.909 371.599C401.314 371.242 400.846 370.75 400.505 370.124C400.172 369.497 400.005 368.795 400.005 368.017C400.005 367.24 400.172 366.538 400.505 365.911C400.846 365.284 401.314 364.793 401.909 364.436C402.504 364.079 403.171 363.9 403.908 363.9C404.757 363.9 405.503 364.126 406.146 364.578C406.788 365.031 407.256 365.637 407.55 366.399L405.812 366.423C405.598 366.105 405.325 365.856 404.991 365.673C404.658 365.491 404.297 365.399 403.908 365.399C403.464 365.399 403.064 365.514 402.707 365.745C402.358 365.967 402.084 366.276 401.885 366.673C401.687 367.069 401.588 367.518 401.588 368.017C401.588 368.509 401.687 368.954 401.885 369.35C402.084 369.747 402.358 370.06 402.707 370.29C403.064 370.512 403.464 370.624 403.908 370.624C404.448 370.624 404.92 370.457 405.325 370.124C405.729 369.791 406.003 369.35 406.146 368.803H403.908V367.387H407.764C407.796 367.569 407.812 367.779 407.812 368.017ZM411.92 364.067H413.432V371.968H411.92V364.067ZM419.4 366.506V371.968H417.889V364.067H419.233L423.898 369.517V364.067H425.409V371.968H424.041L419.4 366.506ZM431.388 367.303H435.743V368.72H431.388V370.54H437.231V371.968H429.876V364.067H437.231V365.483H431.388V367.303ZM442.992 367.303H447.347V368.72H442.992V370.54H448.835V371.968H441.481V364.067H448.835V365.483H442.992V367.303ZM454.596 371.968H453.085V364.067H458.5C459.174 364.067 459.717 364.285 460.13 364.721C460.542 365.15 460.749 365.721 460.749 366.435C460.749 367.061 460.566 367.581 460.201 367.994C459.844 368.406 459.368 368.644 458.773 368.708L460.749 371.968H459.047L457.143 368.72H454.596V371.968ZM458.5 367.303C458.722 367.303 458.9 367.232 459.035 367.089C459.17 366.938 459.237 366.744 459.237 366.506V366.28C459.237 366.042 459.17 365.852 459.035 365.709C458.9 365.558 458.722 365.483 458.5 365.483H454.596V367.303H458.5ZM464.91 364.067H466.422V371.968H464.91V364.067ZM472.39 366.506V371.968H470.878V364.067H472.223L476.888 369.517V364.067H478.399V371.968H477.031L472.39 366.506ZM490.304 368.017C490.304 368.771 490.141 369.461 489.816 370.088C489.491 370.715 489.03 371.211 488.435 371.576C487.848 371.94 487.17 372.123 486.401 372.123C485.663 372.123 484.996 371.948 484.401 371.599C483.806 371.242 483.338 370.75 482.997 370.124C482.664 369.497 482.497 368.795 482.497 368.017C482.497 367.24 482.664 366.538 482.997 365.911C483.338 365.284 483.806 364.793 484.401 364.436C484.996 364.079 485.663 363.9 486.401 363.9C487.249 363.9 487.995 364.126 488.638 364.578C489.28 365.031 489.748 365.637 490.042 366.399L488.305 366.423C488.09 366.105 487.817 365.856 487.483 365.673C487.15 365.491 486.789 365.399 486.401 365.399C485.956 365.399 485.556 365.514 485.199 365.745C484.85 365.967 484.576 366.276 484.378 366.673C484.179 367.069 484.08 367.518 484.08 368.017C484.08 368.509 484.179 368.954 484.378 369.35C484.576 369.747 484.85 370.06 485.199 370.29C485.556 370.512 485.956 370.624 486.401 370.624C486.94 370.624 487.412 370.457 487.817 370.124C488.221 369.791 488.495 369.35 488.638 368.803H486.401V367.387H490.256C490.288 367.569 490.304 367.779 490.304 368.017Z" fill="#16150D"/>
          <path d="M378.859 318.463H404.469L406.192 307.833H377.527C367.796 307.833 361.11 313.283 359.63 322.407C358.946 326.656 359.679 330.208 361.77 332.694C364.019 335.376 367.735 336.797 372.502 336.797H384.788C386.585 336.797 387.819 337.213 388.528 338.058C389.127 338.768 389.335 339.736 389.139 340.948C388.883 342.565 387.77 344.488 383.956 344.488H357.1L355.376 355.118H385.509C394.799 355.118 402.011 349.117 403.466 340.201C404.151 335.976 403.466 332.596 401.437 330.183C399.224 327.563 395.459 326.179 390.533 326.179H377.954C376.329 326.179 375.094 325.726 374.373 324.856C373.957 324.366 373.517 323.509 373.737 322.162C374.116 319.823 375.986 318.488 378.871 318.488L378.859 318.463Z" fill="#16150D"/>
          <path d="M272.338 325.174L287.85 307.196H299.255L291.53 356.122H278.291L282.337 330.404L275.797 337.997H264.478L260.212 330.404L256.165 356.122H243L250.726 307.196H262.045L272.338 325.174Z" fill="#16150D"/>
          <path d="M296.26 356.122L323.618 307.196H339.95L351.795 356.122H337.676L334.95 344.549H316.565L310.245 356.122H296.273H296.26ZM322.958 332.767H332.297L329.351 321.427L322.958 332.767Z" fill="#16150D"/>
          <path d="M426.399 319.063H408.747L410.581 307.196H459.123L457.289 319.063H439.564L433.684 356.122H420.519L426.399 319.063Z" fill="#16150D"/>
          <path d="M456.641 356.122L464.367 307.196H498.338C502.799 307.196 506.112 308.396 508.264 310.809C510.415 313.221 511.503 316.21 511.503 319.798C511.503 320.68 511.43 321.611 511.283 322.603C510.794 325.75 509.486 328.653 507.347 331.335C505.22 334.017 502.335 335.841 498.704 336.821L498.778 336.968L507.383 356.122H492.531L484.292 337.556H472.74L469.794 356.122H456.629H456.641ZM474.586 325.689H495.404C496.088 325.689 496.675 325.444 497.164 324.954C497.653 324.464 497.946 323.827 498.044 323.043L498.264 321.721C498.362 320.888 498.264 320.239 497.971 319.774C497.678 319.308 497.189 319.075 496.504 319.075H475.686L474.586 325.701V325.689Z" fill="#16150D"/>
          <path d="M543.249 307L511.503 356.122H525.084L556.891 307H543.249Z" fill="#16150D"/>
        </g>
        
        <!-- Meter Graphics -->
        <g id="MeterGraphics">
          <!-- Black Numbers -->
          <g id="Black Numbers">
            <path id="-20" d="M65.6027 271.284H76.2903V274.161H65.6027V271.284ZM86.5167 271.84C87.7419 271.324 88.564 270.897 88.9831 270.559C89.4183 270.22 89.636 269.817 89.636 269.35C89.636 268.737 89.3861 268.262 88.8864 267.923C88.3867 267.585 87.6613 267.415 86.7102 267.415C85.8075 267.415 85.1062 267.633 84.6065 268.068C84.1068 268.487 83.8569 269.019 83.8569 269.664H80.6168C80.6168 268.036 81.1488 266.746 82.2127 265.795C83.2766 264.844 84.7758 264.369 86.7102 264.369C88.5962 264.369 90.0873 264.82 91.1835 265.723C92.2796 266.609 92.8277 267.818 92.8277 269.35C92.8277 270.14 92.6585 270.825 92.3199 271.405C91.9975 271.985 91.4656 272.533 90.7241 273.049C89.9825 273.549 88.9589 274.065 87.6532 274.597C86.4603 275.08 85.5254 275.604 84.8483 276.168C84.1874 276.716 83.8569 277.281 83.8569 277.861H93.1421V280.763H80.3267V278.514C80.3267 277.192 80.8586 275.959 81.9225 274.814C83.0026 273.654 84.534 272.662 86.5167 271.84ZM104.348 281.077C102.027 281.077 100.253 280.368 99.0282 278.949C97.8031 277.514 97.1905 275.443 97.1905 272.735C97.1905 270.043 97.8031 267.979 99.0282 266.545C100.269 265.094 102.043 264.369 104.348 264.369C106.669 264.369 108.442 265.094 109.667 266.545C110.909 267.979 111.529 270.043 111.529 272.735C111.529 275.411 110.909 277.474 109.667 278.925C108.426 280.36 106.653 281.077 104.348 281.077ZM100.382 272.735C100.382 274.46 100.721 275.773 101.398 276.676C102.075 277.579 103.058 278.03 104.348 278.03C105.637 278.03 106.621 277.579 107.298 276.676C107.975 275.773 108.313 274.46 108.313 272.735C108.313 271.01 107.975 269.696 107.298 268.794C106.621 267.875 105.637 267.415 104.348 267.415C103.058 267.415 102.075 267.875 101.398 268.794C100.721 269.696 100.382 271.01 100.382 272.735Z" fill="#392E20"/>
            <path id="-10" d="M121.924 224.557H132.611V227.435H121.924V224.557ZM137.107 217.98H140.178V234.036H137.107V217.98ZM151.507 234.35C149.185 234.35 147.412 233.641 146.187 232.222C144.962 230.788 144.349 228.716 144.349 226.008C144.349 223.316 144.962 221.253 146.187 219.818C147.428 218.367 149.201 217.642 151.507 217.642C153.828 217.642 155.601 218.367 156.826 219.818C158.067 221.253 158.688 223.316 158.688 226.008C158.688 228.684 158.067 230.747 156.826 232.198C155.585 233.633 153.812 234.35 151.507 234.35ZM147.541 226.008C147.541 227.733 147.88 229.047 148.557 229.949C149.234 230.852 150.217 231.304 151.507 231.304C152.796 231.304 153.78 230.852 154.457 229.949C155.134 229.047 155.472 227.733 155.472 226.008C155.472 224.283 155.134 222.97 154.457 222.067C153.78 221.148 152.796 220.689 151.507 220.689C150.217 220.689 149.234 221.148 148.557 222.067C147.88 222.97 147.541 224.283 147.541 226.008Z" fill="#392E20"/>
            <path id="-7" d="M180.471 191.53H191.159V194.407H180.471V191.53ZM195.05 184.953H207.261V187.516L201.168 201.008H197.831L203.755 187.83H195.05V184.953Z" fill="#392E20"/>
            <path id="-5" d="M233.723 166.594H244.41V169.471H233.723V166.594ZM255 166.11C257.047 166.11 258.627 166.546 259.739 167.416C260.851 168.287 261.407 169.536 261.407 171.164C261.407 172.857 260.851 174.154 259.739 175.057C258.643 175.944 257.063 176.387 255 176.387C252.936 176.387 251.356 175.96 250.26 175.105C249.164 174.251 248.616 173.018 248.616 171.406H251.808C251.808 172.035 252.082 172.518 252.63 172.857C253.178 173.179 253.968 173.34 255 173.34C256.031 173.34 256.821 173.155 257.369 172.784C257.917 172.413 258.191 171.873 258.191 171.164C258.191 169.729 257.127 169.012 255 169.012H248.906V160.017H260.343V162.894H251.977V166.11H255Z" fill="#392E20"/>
            <path id="-3" d="M318.948 146.768H329.636V149.646H318.948V146.768ZM337.033 151.58C337.033 152.209 337.307 152.692 337.856 153.031C338.404 153.353 339.193 153.514 340.225 153.514C341.257 153.514 342.047 153.353 342.595 153.031C343.143 152.692 343.417 152.209 343.417 151.58C343.417 150.967 343.143 150.5 342.595 150.177C342.063 149.839 341.273 149.662 340.225 149.646L337.928 149.621V146.816L340.225 146.768C342.063 146.72 342.982 146.075 342.982 144.834C342.982 144.221 342.732 143.746 342.232 143.407C341.732 143.069 341.007 142.899 340.056 142.899C339.137 142.899 338.428 143.069 337.928 143.407C337.444 143.746 337.203 144.221 337.203 144.834H333.963C333.963 143.222 334.486 141.989 335.534 141.134C336.582 140.28 338.089 139.853 340.056 139.853C342.039 139.853 343.554 140.28 344.602 141.134C345.65 141.989 346.173 143.222 346.173 144.834C346.173 146.285 345.633 147.381 344.553 148.122C345.94 148.815 346.633 149.968 346.633 151.58C346.633 153.192 346.077 154.425 344.964 155.279C343.868 156.134 342.289 156.561 340.225 156.561C338.162 156.561 336.582 156.134 335.486 155.279C334.39 154.425 333.842 153.192 333.842 151.58H337.033Z" fill="#392E20"/>
            <path id="-2" d="M371.231 143.971H381.918V146.848H371.231V143.971ZM392.145 144.527C393.37 144.011 394.192 143.584 394.611 143.245C395.046 142.907 395.264 142.504 395.264 142.036C395.264 141.424 395.014 140.948 394.514 140.609C394.015 140.271 393.289 140.102 392.338 140.102C391.435 140.102 390.734 140.319 390.234 140.755C389.735 141.174 389.485 141.706 389.485 142.35H386.245C386.245 140.722 386.777 139.433 387.841 138.482C388.905 137.531 390.404 137.055 392.338 137.055C394.224 137.055 395.715 137.506 396.811 138.409C397.908 139.296 398.456 140.505 398.456 142.036C398.456 142.826 398.286 143.511 397.948 144.091C397.625 144.672 397.094 145.22 396.352 145.736C395.61 146.235 394.587 146.751 393.281 147.283C392.088 147.767 391.153 148.291 390.476 148.855C389.815 149.403 389.485 149.967 389.485 150.547H398.77V153.449H385.955V151.2C385.955 149.878 386.487 148.645 387.55 147.501C388.631 146.34 390.162 145.349 392.145 144.527Z" fill="#392E20"/>
            <path id="-1" d="M438.871 146.768H449.559V149.646H438.871V146.768ZM454.054 140.191H457.125V156.247H454.054V140.191Z" fill="#392E20"/>
            <path id="0" d="M519.344 167.243C517.023 167.243 515.25 166.533 514.025 165.115C512.799 163.68 512.187 161.609 512.187 158.901C512.187 156.209 512.799 154.145 514.025 152.711C515.266 151.26 517.039 150.534 519.344 150.534C521.665 150.534 523.439 151.26 524.664 152.711C525.905 154.145 526.526 156.209 526.526 158.901C526.526 161.577 525.905 163.64 524.664 165.091C523.422 166.525 521.649 167.243 519.344 167.243ZM515.379 158.901C515.379 160.625 515.717 161.939 516.394 162.842C517.071 163.745 518.055 164.196 519.344 164.196C520.634 164.196 521.617 163.745 522.294 162.842C522.971 161.939 523.31 160.625 523.31 158.901C523.31 157.176 522.971 155.862 522.294 154.959C521.617 154.04 520.634 153.581 519.344 153.581C518.055 153.581 517.071 154.04 516.394 154.959C515.717 155.862 515.379 157.176 515.379 158.901Z" fill="#392E20"/>
          </g>
          
          <!-- Red Numbers -->
          <g id="Red Numbers">
            <path id="+1" d="M591.601 188.732V191.609H587.031V196.615H583.96V191.609H579.39V188.732H583.96V183.751H587.031V188.732H591.601ZM596.085 182.155H599.156V198.211H596.085V182.155Z" fill="#CE242B"/>
            <path id="+2" d="M667.365 229.517V232.394H662.795V237.399H659.724V232.394H655.154V229.517H659.724V224.536H662.795V229.517H667.365ZM677.579 230.073C678.804 229.557 679.627 229.13 680.046 228.791C680.481 228.453 680.698 228.05 680.698 227.582C680.698 226.97 680.449 226.494 679.949 226.156C679.449 225.817 678.724 225.648 677.773 225.648C676.87 225.648 676.169 225.866 675.669 226.301C675.169 226.72 674.919 227.252 674.919 227.897H671.679C671.679 226.269 672.211 224.979 673.275 224.028C674.339 223.077 675.838 222.601 677.773 222.601C679.659 222.601 681.15 223.053 682.246 223.955C683.342 224.842 683.89 226.051 683.89 227.582C683.89 228.372 683.721 229.057 683.382 229.638C683.06 230.218 682.528 230.766 681.787 231.282C681.045 231.782 680.021 232.297 678.716 232.829C677.523 233.313 676.588 233.837 675.911 234.401C675.25 234.949 674.919 235.513 674.919 236.094H684.205V238.995H671.389V236.747C671.389 235.425 671.921 234.192 672.985 233.047C674.065 231.886 675.597 230.895 677.579 230.073Z" fill="#CE242B"/>
            <path id="+3" d="M714.005 282.567V285.444H709.435V290.45H706.364V285.444H701.794V282.567H706.364V277.586H709.435V282.567H714.005ZM721.39 287.379C721.39 288.007 721.664 288.491 722.212 288.83C722.76 289.152 723.55 289.313 724.582 289.313C725.614 289.313 726.403 289.152 726.951 288.83C727.5 288.491 727.774 288.007 727.774 287.379C727.774 286.766 727.5 286.299 726.951 285.976C726.42 285.638 725.63 285.46 724.582 285.444L722.285 285.42V282.615L724.582 282.567C726.42 282.519 727.338 281.874 727.338 280.632C727.338 280.02 727.089 279.544 726.589 279.206C726.089 278.867 725.364 278.698 724.413 278.698C723.494 278.698 722.784 278.867 722.285 279.206C721.801 279.544 721.559 280.02 721.559 280.632H718.319C718.319 279.02 718.843 277.787 719.891 276.933C720.939 276.079 722.446 275.651 724.413 275.651C726.395 275.651 727.911 276.079 728.958 276.933C730.006 277.787 730.53 279.02 730.53 280.632C730.53 282.083 729.99 283.179 728.91 283.921C730.296 284.614 730.99 285.767 730.99 287.379C730.99 288.991 730.433 290.224 729.321 291.078C728.225 291.933 726.645 292.36 724.582 292.36C722.518 292.36 720.939 291.933 719.843 291.078C718.746 290.224 718.198 288.991 718.198 287.379H721.39Z" fill="#CE242B"/>
          </g>
          
          <!-- VU Labels -->
          <g id="VU Labels">
            <path id="VU" d="M93.1461 150.704L95.8061 157.312L95.8901 157.06L96.3241 155.898C96.3708 155.805 96.4314 155.655 96.5061 155.45L98.3401 150.816L98.3821 150.704H101.042L97.3181 160H94.2101L90.4721 150.704H93.1461ZM103.354 157.69C103.027 156.971 102.864 156.248 102.864 155.52V150.704H105.37V155.52C105.37 155.893 105.44 156.257 105.58 156.612C105.72 156.967 105.934 157.261 106.224 157.494C106.522 157.718 106.886 157.83 107.316 157.83C107.736 157.83 108.09 157.718 108.38 157.494C108.678 157.261 108.898 156.967 109.038 156.612C109.178 156.257 109.248 155.893 109.248 155.52V150.704H111.754V155.52C111.754 156.248 111.59 156.971 111.264 157.69C110.937 158.399 110.438 158.992 109.766 159.468C109.103 159.935 108.286 160.168 107.316 160.168C106.345 160.168 105.524 159.935 104.852 159.468C104.18 158.992 103.68 158.399 103.354 157.69Z" fill="#504523"/>
            <path d="M716.449 135.171H643.686V172.881H716.449V135.171Z" fill="#CE242B"/>
            <path id="VU_2" d="M671.646 150.704L674.306 157.312L674.39 157.06L674.824 155.898C674.871 155.805 674.931 155.655 675.006 155.45L676.84 150.816L676.882 150.704H679.542L675.818 160H672.71L668.972 150.704H671.646ZM681.854 157.69C681.527 156.971 681.364 156.248 681.364 155.52V150.704H683.87V155.52C683.87 155.893 683.94 156.257 684.08 156.612C684.22 156.967 684.434 157.261 684.724 157.494C685.022 157.718 685.386 157.83 685.816 157.83C686.236 157.83 686.59 157.718 686.88 157.494C687.178 157.261 687.398 156.967 687.538 156.612C687.678 156.257 687.748 155.893 687.748 155.52V150.704H690.254V155.52C690.254 156.248 690.09 156.971 689.764 157.69C689.437 158.399 688.938 158.992 688.266 159.468C687.603 159.935 686.786 160.168 685.816 160.168C684.845 160.168 684.024 159.935 683.352 159.468C682.68 158.992 682.18 158.399 681.854 157.69Z" fill="#FEF888"/>
          </g>
          
          <!-- Lines and meter arcs -->
          <g id="Lines">
            <!-- Black meter line -->
            <g id="black meter line">
              <mask id="mask0_39_1020" style="mask-type:luminance" maskUnits="userSpaceOnUse" x="63" y="79" width="672" height="248">
                <g id="clippath">
                  <path d="M734.404 326.506L134.306 324.009L65.5579 277.305L63.354 79H734.404V326.506Z" fill="white"/>
                </g>
              </mask>
              <g mask="url(#mask0_39_1020)">
                <g id="Group">
                  <path d="M395.66 969.316C610.617 969.316 784.874 794.734 784.874 579.376C784.874 364.018 610.617 189.436 395.66 189.436C180.702 189.436 6.44458 364.018 6.44458 579.376C6.44458 794.734 180.702 969.316 395.66 969.316Z" stroke="black" stroke-width="2.43" stroke-miterlimit="10"/>
                </g>
              </g>
            </g>
            
            <!-- Vertical markers -->
            <g id="vertical markers">
              <mask id="mask1_39_1020" style="mask-type:luminance" maskUnits="userSpaceOnUse" x="61" y="80" width="676" height="251">
                <g id="clippath-1">
                  <path d="M395.636 190.603C515.64 190.603 623.239 244.74 695.449 329.882L736.758 330.055V80.815H61L63.2154 280.508L110.986 312.969C182.677 237.619 283.779 190.603 395.636 190.603Z" fill="white"/>
                </g>
              </mask>
              <g mask="url(#mask1_39_1020)">
                <g mask="url(#mask2_39_1020)">
                  <g>
                    <path d="M396.802 589.295L719.807 307.073" stroke="#CE242B" stroke-width="2.43" stroke-miterlimit="10"/>
                    <path d="M396.802 589.295L657.913 249.248" stroke="#CE242B" stroke-width="2.43" stroke-miterlimit="10"/>
                    <path d="M396.802 589.295L588.069 208.602" stroke="#CE242B" stroke-width="2.43" stroke-miterlimit="10"/>
                    <path d="M396.802 589.295L548.756 202.094" stroke="#CE242B" stroke-width="2.43" stroke-miterlimit="10"/>
                    <path d="M396.802 589.295L517.394 179.702" stroke="black" stroke-width="2.43" stroke-miterlimit="10"/>
                    <path d="M396.802 589.295L479.489 183.817" stroke="black" stroke-width="2.43" stroke-miterlimit="10"/>
                    <path d="M396.802 589.295L453.711 169.147" stroke="black" stroke-width="2.43" stroke-miterlimit="10"/>
                    <path d="M396.802 589.295L395.556 165.448" stroke="black" stroke-width="2.43" stroke-miterlimit="10"/>
                    <path d="M396.802 589.295L347.601 169.147" stroke="black" stroke-width="2.43" stroke-miterlimit="10"/>
                    <path d="M396.802 589.295L300.476 189.817" stroke="black" stroke-width="2.43" stroke-miterlimit="10"/>
                    <path d="M396.802 589.295L265.214 188.002" stroke="black" stroke-width="2.43" stroke-miterlimit="10"/>
                    <path d="M396.802 589.295L238.617 213.562" stroke="black" stroke-width="2.43" stroke-miterlimit="10"/>
                    <path d="M396.802 589.295L209.17 212.383" stroke="black" stroke-width="2.43" stroke-miterlimit="10"/>
                    <path d="M396.802 589.295L155.214 246.312" stroke="black" stroke-width="2.43" stroke-miterlimit="10"/>
                    <path d="M396.802 589.295L104.617 294.495" stroke="black" stroke-width="2.43" stroke-miterlimit="10"/>
                  </g>
                </g>
              </g>
            </g>
            
            <!-- Red meter line -->
            <g id="red meter line">
              <mask id="mask3_39_1020" style="mask-type:luminance" maskUnits="userSpaceOnUse" x="476" y="79" width="259" height="293">
                <g id="clippath-3">
                  <path d="M716.438 311.2L652.098 371.776L476.627 329.835L545.364 82.5606L734.404 79L716.438 311.2Z" fill="white"/>
                </g>
              </mask>
              <g mask="url(#mask3_39_1020)">
                <g>
                  <path d="M395.66 969.316C610.617 969.316 784.874 794.734 784.874 579.376C784.874 364.018 610.617 189.436 395.66 189.436C180.702 189.436 6.44458 364.018 6.44458 579.376C6.44458 794.734 180.702 969.316 395.66 969.316Z" stroke="#CE242B" stroke-width="13.22" stroke-miterlimit="10"/>
                </g>
              </g>
            </g>
          </g>
        </g>
        
        <!-- Needle -->
        <g id="Needle">
          <path id="Needle_2" d="M515.887 227.664C515.977 227.377 516.059 227.04 516.152 226.669C516.671 224.36 516.598 221.974 516.12 219.643C514.608 212.25 514.519 201.171 516.217 188.255C516.498 186.089 516.838 183.966 517.2 181.851C517.132 181.26 517.06 180.91 516.983 180.886C516.906 180.862 516.647 181.107 516.253 181.553C515.344 183.485 514.406 185.432 513.399 187.37C507.408 198.938 501.001 207.977 495.534 213.179C493.824 214.811 492.4 216.726 491.492 218.925C491.345 219.279 491.233 219.595 491.14 219.893C489.38 225.496 491.552 231.327 496.044 234.507L404.328 514.981L418.408 519.403L503.497 236.848C509.001 236.807 514.117 233.264 515.876 227.661L515.887 227.664Z" fill="black"/>
        </g>
        
        <!-- Bezel Frame -->
        <g id="BezelFrame" filter="url(#filter0_d_39_1020)">
          <rect width="50" height="480" fill="#5B5C59"/>
          <rect x="750" width="50" height="480" fill="#495146"/>
          <path d="M800 0L750 50L50 50L0 -3.49691e-05L800 0Z" fill="#62665A"/>
          <path d="M750 425L800 480L-2.40413e-06 480L50 425L750 425Z" fill="#283026"/>
        </g>
        
        <!-- Dimmer overlay -->
        <rect id="Dimmer" width="800" height="480" fill="#060606" fill-opacity="0.85" :style="{ opacity: hardwareStore.dimmerOpacity }" pointer-events="none"/>
        
        <!-- Parameter Overlay Group -->
        <ParameterOverlay />
      </g>
    </svg>
  </div>
</template>

<script>
import { gsap } from 'gsap'
import AudioAnalysisService from '../services/AudioAnalysisService'
import CompressionService from '../services/CompressionService'
import { useAudioControlStore } from '../stores/audioControlStore'
import { useJuceIntegration } from '../composables/useJuceIntegration'
import { useHardwareStore } from '../stores/hardwareStore'
import { ref, onMounted, onUnmounted, nextTick, computed, watch } from 'vue'

export default {
  name: 'VUMeter',
  
  components: {
    ParameterOverlay: () => import('./ParameterOverlay.vue')
  },
  
  props: {
    animated: {
      type: Boolean,
      default: true
    }
  },
  
  setup() {
    const { isHardwareRoute } = useJuceIntegration()
    const hardwareStore = useHardwareStore()
    
    // SVG element refs
    const vuMeterSvg = ref(null)
    const needleElement = ref(null)
    
    // Audio service initialization
    const audioService = ref(null)
    const store = ref(null)
    
    // Current VU meter value and animation state
    const currentValue = ref(0)
    const targetValue = ref(0)
    const isAnimating = ref(false)
    
    // Compression mode - start in demo mode to see if needle works
    const isCompressionMode = ref(false) // True for real compression, false for demo
    const needleAnimation = ref(null) // Store GSAP animation instance
    
    // Animation parameters
    const SAMPLE_RATE = 44100
    const BUFFER_SIZE = 512
    const UPDATE_INTERVAL = BUFFER_SIZE / SAMPLE_RATE * 1000 // ~11.6ms
    
    // dB to angle conversion - DISABLED for original position testing
    const convertDBToAngle = (dbValue) => {
      // Return 0 to keep needle in original position for now
      return 0
    }
    
    // Animate needle to target position - DISABLED for original position testing
    const animateNeedle = () => {
      if (!vuMeterSvg.value) return
      
      const needleSvg = vuMeterSvg.value.querySelector('#Needle')
      if (!needleSvg) return
      
      // No animation for now - keep original position
      console.log('üéöÔ∏è Needle found but keeping original position')
      
      currentValue.value = targetValue.value
    }
    
    // Update VU meter with new value
    const updateVUMeter = (dbValue) => {
      if (!isCompressionMode.value) {
        console.log('üéöÔ∏è Skipping update - in demo mode')
        return // Skip if in demo mode
      }
      
      if (typeof dbValue !== 'number' || isNaN(dbValue)) {
        console.warn('‚ö†Ô∏è Invalid VU meter value:', dbValue)
        return
      }
      
      // Get compression settings from hardware store
      const compressionState = hardwareStore.compression
      const peakReduction = compressionState.peakReduction
      
      console.log('üéöÔ∏è Audio update:', {
        dbValue: dbValue.toFixed(1) + ' dB',
        peakReduction: peakReduction + (peakReduction === 0 ? ' (No compression!)' : ''),
        mode: compressionState.meterMode
      })
      
      // Calculate needle position using CompressionService
      const targetPosition = CompressionService.calculateNeedlePosition(dbValue, peakReduction)
      const smoothedPosition = CompressionService.smoothNeedleMovement(
        targetPosition, 
        compressionState.smoothingMultiplier
      )
      
      console.log('üéØ Needle position:', {
        target: targetPosition.toFixed(1),
        smoothed: smoothedPosition.toFixed(1)
      })
      
      // Update store with new needle position
      hardwareStore.updateNeedlePosition(smoothedPosition)
      
      // Animate needle using GSAP
      if (vuMeterSvg.value) {
        const needleSvg = vuMeterSvg.value.querySelector('#Needle')
        if (needleSvg) {
          gsap.to(needleSvg, {
            rotation: smoothedPosition,
            transformOrigin: "0px 400px",
            duration: 0.1,
            ease: "power2.out"
          })
        }
      }
    }
    
    // Initialize audio service and store integration
    const initAudio = async () => {
      try {
        // Import stores
        const { useAudioControlStore } = await import('../stores/audioControlStore')
        store.value = useAudioControlStore()
        
        // Create audio service
        audioService.value = new AudioAnalysisService()
        await audioService.value.init()
        
        // Connect audio service to store for modal control
        store.value.setAudioService(audioService.value)
        
        // Set up VU meter callback using the correct callback name
        audioService.value.onVolumeUpdate = (volume, dbLevel) => {
          // Use the dB level for VU meter
          updateVUMeter(dbLevel)
        }
        
        console.log('‚úÖ VU Meter audio initialized')
        
      } catch (error) {
        console.error('‚ùå Failed to initialize VU Meter audio:', error)
      }
    }
    
    // Keyboard event handler
    const handleKeyDown = (event) => {
      // 'N' key toggles audio playback
      if (event.key.toLowerCase() === 'n') {
        event.preventDefault()
        if (store.value) {
          if (store.value.isPlaying) {
            store.value.pause()
          } else {
            // Load track if not loaded
            if (!store.value.currentTrack?.isLoaded) {
              loadCurrentTrack()
            } else {
              store.value.play()
            }
          }
        }
      }
      
      // 'M' key toggles audio control modal
      if (event.key.toLowerCase() === 'm') {
        event.preventDefault()
        if (store.value) {
          store.value.toggleModal()
        }
      }
      
      // 'T' key for testing compression (manual trigger)
      if (event.key.toLowerCase() === 't') {
        event.preventDefault()
        console.log('üß™ Manual test trigger')
        // Simulate audio level for testing
        const testLevel = -10 + Math.random() * 15 // Random between -10 and +5 dB
        updateVUMeter(testLevel)
      }
    }
    
    // Load current track
    const loadCurrentTrack = async () => {
      if (!store.value || !audioService.value) return
      
      const track = store.value.currentTrack
      if (!track) return
      
      try {
        store.value.setLoading(true)
        console.log('üîÑ Loading track:', track.name)
        
        const loadSuccess = await audioService.value.loadTrack(track.url)
        
        if (loadSuccess) {
          store.value.markTrackLoaded(track.id, false)
          console.log('‚úÖ Track loaded successfully:', track.name)
          // Auto-play after loading
          store.value.play()
        } else {
          console.log('‚ö†Ô∏è Track load failed, using fallback audio for:', track.name)
          store.value.markTrackLoaded(track.id, true)
          store.value.setFallbackMode(true)
          // Auto-play fallback
          store.value.play()
        }
        
        store.value.setLoading(false)
      } catch (error) {
        console.error('‚ùå Failed to load track:', track.name, error)
        store.value.setFallbackMode(true)
        store.value.setLoading(false)
      }
    }
    
    // Demo animation function (preserving old behavior)
    const startDemoAnimation = () => {
      if (vuMeterSvg.value) {
        const needleSvg = vuMeterSvg.value.querySelector('#Needle')
        if (needleSvg) {
          // Clear all transforms first
          gsap.set(needleSvg, { 
            clearProps: "all"
          })
          
          needleAnimation.value = gsap.fromTo(needleSvg, 
            {
              rotation: 33.3,
              transformOrigin: "0px 400px"  // Pivot at bottom center of needle
            },
            {
              rotation: -62.1,
              duration: 2,
              yoyo: true,
              repeat: -1,
              ease: "power2.inOut",
            }
          )
          
          console.log('üéöÔ∏è Demo needle animation started')
        }
      }
    }
    
    // Stop demo animation
    const stopDemoAnimation = () => {
      if (needleAnimation.value) {
        needleAnimation.value.kill()
        needleAnimation.value = null
      }
    }
    
    // Toggle between demo and compression mode
    const toggleMode = () => {
      isCompressionMode.value = !isCompressionMode.value
      if (isCompressionMode.value) {
        stopDemoAnimation()
        // Reset needle to 0
        if (vuMeterSvg.value) {
          const needleSvg = vuMeterSvg.value.querySelector('#Needle')
          if (needleSvg) {
            gsap.set(needleSvg, {
              rotation: 0,
              transformOrigin: "0px 400px"
            })
          }
        }
      } else {
        startDemoAnimation()
      }
    }
    
    // Watch for meter mode changes from the store
    watch(() => hardwareStore.compression.meterMode, (newMode) => {
      console.log('üéöÔ∏è Meter mode changed to:', newMode)
      // Additional logic for VU vs GR mode can be added here
    })
    
    onMounted(async () => {
      // Initialize needle position
      nextTick(() => {
        if (isCompressionMode.value) {
          // Set needle to 0 for compression mode
          if (vuMeterSvg.value) {
            const needleSvg = vuMeterSvg.value.querySelector('#Needle')
            if (needleSvg) {
              gsap.set(needleSvg, {
                rotation: 0,
                transformOrigin: "0px 400px"
              })
            }
          }
        } else {
          // Start demo animation
          startDemoAnimation()
        }
      })
      
      // Add keyboard event listener
      window.addEventListener('keydown', handleKeyDown)
      
      // Initialize audio
      await initAudio()
      
      // Auto-load default track for testing
      if (store.value && !store.value.currentTrack?.isLoaded) {
        console.log('üéµ Auto-loading default track...')
        await loadCurrentTrack()
      }
      
      console.log('üéöÔ∏è VU Meter mounted and ready')
    })
    
    onUnmounted(() => {
      // Remove keyboard event listener
      window.removeEventListener('keydown', handleKeyDown)
      
      // Stop demo animation if running
      stopDemoAnimation()
      
      // Cleanup audio service
      if (audioService.value) {
        audioService.value.destroy()
      }
      
      console.log('üéöÔ∏è VU Meter unmounted')
    })
    
    return {
      isHardwareRoute,
      hardwareStore,
      vuMeterSvg,
      updateVUMeter,
      isCompressionMode,
      toggleMode,
      startDemoAnimation,
      stopDemoAnimation
    }
  }
}
</script>

<style scoped>
.vu-meter-container {
  width: 800px;
  height: 480px;
  position: relative;
  background: #000000;
  box-shadow: 13px 10px 19.8px 0px rgba(0,0,0,0.33);
}

/* Hardware route: make VUMeter responsive to container */
.vu-meter-container.hardware-mode {
  width: 100%;
  height: 100%;
  max-width: 800px;
  max-height: 480px;
  /* Scale down proportionally if container is smaller */
  object-fit: contain;
  /* Maintain aspect ratio */
  aspect-ratio: 800 / 480;
  /* Center the meter if there's extra space */
  margin: auto;
  /* Ensure it doesn't overflow container */
  box-sizing: border-box;
}

/* Fallback for browsers without aspect-ratio support */
@supports not (aspect-ratio: 800 / 480) {
  .vu-meter-container.hardware-mode {
    /* Use container query or scale transform as fallback */
    transform-origin: center center;
  }
  
  .vu-meter-container.hardware-mode:where(.container-height-420) {
    /* When WebSocket header is visible (420px available) */
    transform: scale(0.875); /* 420/480 = 0.875 */
  }
}

.bezel-frame {
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, #62665a 0%, #283026 100%);
  border: 2px solid #333;
}

.vu-meter-display {
  position: absolute;
  left: 50px;
  top: 50px;
  right: 50px;
  bottom: 50px;
  background: linear-gradient(to bottom, #d5d28f 0%, #fef888 100%);
  border-radius: 8px;
  overflow: hidden;
}

.vu-title {
  position: absolute;
  top: 32px;
  left: 50%;
  transform: translateX(-50%);
  font-family: 'Courier New', monospace;
  font-size: 24.18px;
  font-weight: 500;
  color: #504523;
  letter-spacing: 1px;
  text-align: center;
}

.scale-numbers {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

.black-numbers .number {
  position: absolute;
  font-family: 'Courier New', monospace;
  font-size: 24.18px;
  font-weight: 500;
  color: #392e20;
  transform: translateX(-50%);
}

.red-numbers .number-red {
  position: absolute;
  font-family: 'Courier New', monospace;
  font-size: 24.18px;
  font-weight: 500;
  color: #ce242b;
  transform: translateX(-50%);
}

.vu-labels {
  position: absolute;
  top: 140px;
  left: 0;
  width: 100%;
}

.vu-label-left {
  position: absolute;
  left: 81px;
  font-family: 'Courier New', monospace;
  font-size: 12px;
  font-weight: 900;
  color: #504523;
}

.vu-label-right {
  position: absolute;
  right: 80px;
}

.red-vu-box {
  background: #ce242b;
  color: #fef888;
  padding: 6px 12px;
  font-family: 'Courier New', monospace;
  font-size: 12px;
  font-weight: 900;
}

.meter-container {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 400px;
  height: 400px;
}

.meter-arc-bg {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 340px;
  height: 340px;
  border: 2.43px solid #000;
  border-radius: 50%;
}

.scale-markings {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 360px;
  height: 360px;
}

.tick-mark {
  position: absolute;
  top: 10px;
  left: 50%;
  width: 2.43px;
  height: 40px;
  background: #000;
  transform-origin: 50% 170px;
  margin-left: -1.215px;
}

.tick-mark.tick-red {
  background: #ce242b;
  height: 45px;
}

.red-arc-overlay {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 340px;
  height: 340px;
  border: 6.61px solid transparent;
  border-radius: 50%;
  border-top-color: #ce242b;
  border-right-color: #ce242b;
  clip-path: polygon(50% 50%, 100% 0%, 100% 50%, 85% 85%);
}

.needle-container {
  position: absolute;
  top: 50%;
  left: 50%;
  transform-origin: 50% 50%;
  /* GPU acceleration for smooth GSAP animation */
  will-change: transform;
  /* GSAP handles all transitions - no CSS transitions needed */
  /* Prevent subpixel rendering issues */
  backface-visibility: hidden;
  transform-style: preserve-3d;
}

.needle {
  position: absolute;
  width: 4px;
  height: 120px;
  background: #000;
  /* left: -2px;
  top: -110px; */
  clip-path: polygon(0% 100%, 50% 85%, 100% 100%, 45% 0%, 55% 0%);
}

.center-hub {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 16px;
  height: 16px;
  background: #000;
  border-radius: 50%;
  z-index: 10;
}

.branding {
  position: absolute;
  bottom: 60px;
  left: 50%;
  transform: translateX(-50%);
  text-align: center;
}

.mastr-logo {
  font-family: 'Courier New', monospace;
  font-size: 48px;
  font-weight: 900;
  color: #16150d;
  opacity: 0.66;
  letter-spacing: 2px;
  margin-bottom: 8px;
}

.design-engineering {
  font-family: 'Courier New', monospace;
  font-size: 11.9px;
  font-weight: 500;
  color: #16150d;
  opacity: 0.66;
  letter-spacing: 2.261px;
}

/* Responsive adjustments for exact pixel positioning */
@media (max-width: 800px) {
  .vu-meter-container {
    transform: scale(0.8);
    transform-origin: top left;
  }
}
</style>
